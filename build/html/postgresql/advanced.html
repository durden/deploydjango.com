

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Advanced &mdash; Useful Patterns for Deploying Django on Heroku</title>
    
    <link rel="stylesheet" href="../_static/deploydjango.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Useful Patterns for Deploying Django on Heroku" href="../index.html" />
    <link rel="up" title="PostgreSQL" href="index.html" />
    <link rel="next" title="Resources" href="resources.html" />
    <link rel="prev" title="Setup" href="setup.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="resources.html" title="Resources"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="setup.html" title="Setup"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Deploy Django</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">PostgreSQL</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Advanced</a><ul>
<li><a class="reference internal" href="#creating-read-slaves">Creating Read Slaves</a></li>
<li><a class="reference internal" href="#creating-a-duplicate-database">Creating a Duplicate Database</a></li>
<li><a class="reference internal" href="#promoting-a-slave-database-to-a-master-database">Promoting a Slave Database to a Master Database</a></li>
<li><a class="reference internal" href="#view-slow-queries">View Slow Queries</a></li>
<li><a class="reference internal" href="#backing-up-your-database">Backing Up Your Database</a></li>
<li><a class="reference internal" href="#downloading-your-backups">Downloading Your Backups</a></li>
<li><a class="reference internal" href="#restoring-from-a-backup">Restoring From a Backup</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="setup.html"
                        title="previous chapter">Setup</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="resources.html"
                        title="next chapter">Resources</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="advanced">
<h1>Advanced<a class="headerlink" href="#advanced" title="Permalink to this headline">¶</a></h1>
<p>This section covers more advanced PostgreSQL topics. Feel free to skip around
to whatever sections are of interest.</p>
<div class="section" id="creating-read-slaves">
<h2>Creating Read Slaves<a class="headerlink" href="#creating-read-slaves" title="Permalink to this headline">¶</a></h2>
<p>Creating <a class="reference external" href="http://en.wikipedia.org/wiki/Master/slave_(technology)">read slaves</a> is a popular way to
help scale read requests across a cluster of database servers. Luckily, Heroku
makes this process extremely simple with their <a class="reference external" href="https://devcenter.heroku.com/articles/heroku-postgresql#follow_beta">follow</a>
feature.</p>
<p>Let&#8217;s assume your application currently has a single database,
<tt class="docutils literal"><span class="pre">HEROKU_POSTGRESQL_GREEN</span></tt>. In order to create a new read slave database, you
can use the <tt class="docutils literal"><span class="pre">--follow</span></tt> option when creating your new slave databse:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku addons:add heroku-postgresql:ronin --follow HEROKU_POSTGRESQL_GREEN
<span class="go">----&gt; Adding heroku-postgresql:ronin to deploydjango... done, v7 ($200/mo)</span>
<span class="go">      Attached as HEROKU_POSTGRESQL_AMBER</span>
<span class="go">      Follower will become available for read-only queries when up-to-date</span>
<span class="go">      Use `heroku pg:wait` to track status</span>
</pre></div>
</div>
<p>The newly created database, <tt class="docutils literal"><span class="pre">HEROKU_POSTGRESQL_AMBER</span></tt>, will now automatically
stay up-to-date with its master database, <tt class="docutils literal"><span class="pre">HEROKU_POSTGRESQL_GREEN</span></tt>.</p>
<p>Using Heroku&#8217;s <tt class="docutils literal"><span class="pre">follow</span></tt> feature, you can create as many read slaves as you like.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While Heroku ensures your new slave database will follow its master, there
will be some replication delay. This means that newly written data to the
master database may take several seconds to reach your slave database.</p>
</div>
</div>
<div class="section" id="creating-a-duplicate-database">
<h2>Creating a Duplicate Database<a class="headerlink" href="#creating-a-duplicate-database" title="Permalink to this headline">¶</a></h2>
<p>In many situations, the ability to create a duplicate database can be extremely
useful:</p>
<ul class="simple">
<li>You want to run tests against your production data, but you don&#8217;t want to
expose your production database to your testing code.</li>
<li>You want to test database migrations before applying them to production.</li>
<li>You want a copy of a production database just incase something bad happens.</li>
</ul>
<p>Duplicating a database using Heroku is really simple thanks to Heroku&#8217;s
<a class="reference external" href="https://devcenter.heroku.com/articles/heroku-postgresql#fork_beta">fork</a>
feature. To duplicate (fork) a copy of your production database,
<tt class="docutils literal"><span class="pre">HEROKU_POSTGRESQL_GREEN</span></tt>, you can create a new database using the <tt class="docutils literal"><span class="pre">--fork</span></tt>
option:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku addons:add heroku-postgresql:ronin --fork HEROKU_POSTGRESQL_GREEN
<span class="go">----&gt; Adding heroku-postgresql:ronin to deploydjango... done, v7 ($200/mo)</span>
<span class="go">      Attached as HEROKU_POSTGRESQL_AMBER</span>
<span class="go">      Database will become available after it completes forking</span>
<span class="go">      Use `heroku pg:wait` to track status</span>
</pre></div>
</div>
<p>Once the new database is up and running, you&#8217;ll be able to use it like any
other master database&#8211;you can perform write queries, give it a read slave,
whatever you want.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Forked databases do <strong>NOT</strong> stay up-to-date with the database they were
forked from.</p>
</div>
</div>
<div class="section" id="promoting-a-slave-database-to-a-master-database">
<h2>Promoting a Slave Database to a Master Database<a class="headerlink" href="#promoting-a-slave-database-to-a-master-database" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s say you&#8217;re in a situation where you need to make one of your read slaves
writable (as a master). Heroku makes this process extremely simple using their
<a class="reference external" href="https://devcenter.heroku.com/articles/heroku-postgresql#unfollow">unfollow</a>
command.</p>
<p>Let&#8217;s assume you&#8217;ve got a read slave named <tt class="docutils literal"><span class="pre">HEROKU_POSTGRESQL_AMBER</span></tt>. To make
it writable, all we do is run the <tt class="docutils literal"><span class="pre">pg:unfollow</span></tt> command, like so:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pg:unfollow HEROKU_POSTGRESQL_AMBER
<span class="go"> !    HEROKU_POSTGRESQL_AMBER will become writable and no longer</span>
<span class="go"> !    follow HEROKU_POSTGRESQL_BRONZE. This cannot be undone.</span>

<span class="go"> !    WARNING: Potentially Destructive Action</span>
<span class="go"> !    This command will affect the app: deploydjango</span>
<span class="go"> !    To proceed, type &quot;deploydjango&quot; or re-run this command with --confirm deploydjango</span>

<span class="gp">&gt;</span> deploydjango
<span class="go">Unfollowing... done</span>
</pre></div>
</div>
</div>
<div class="section" id="view-slow-queries">
<h2>View Slow Queries<a class="headerlink" href="#view-slow-queries" title="Permalink to this headline">¶</a></h2>
<p>A big part of writing good code is knowing when you do things wrong. Slow
database queries, in particular, are probably the greatest cause of poor site
performance.</p>
<p>Luckily for us, Heroku&#8217;s logging system allows you to easily view a stream of
slow query logs directly from your console. Any query that takes longer than
50ms to execute will be dumped into the log output.</p>
<p>To view the streaming logs, you can simply run:
<tt class="docutils literal"><span class="pre">heroku</span> <span class="pre">logs</span> <span class="pre">--tail</span> <span class="pre">--ps</span> <span class="pre">postgres</span></tt>. If you&#8217;d like to just view the most
recent logs, you can run the same command without the optional <tt class="docutils literal"><span class="pre">--tail</span></tt>
argument: <tt class="docutils literal"><span class="pre">heroku</span> <span class="pre">logs</span> <span class="pre">--ps</span> <span class="pre">postgres</span></tt>.</p>
</div>
<div class="section" id="backing-up-your-database">
<h2>Backing Up Your Database<a class="headerlink" href="#backing-up-your-database" title="Permalink to this headline">¶</a></h2>
<p>Backing up your database is incredibly important, but not always easy to do. To
combat the complexity of backing up your database, Heroku created their
extremely useful <a class="reference external" href="https://addons.heroku.com/pgbackups">pgbackups addon</a>.</p>
<p>Incredibly, all of the pgbackups addon plans are completely free!</p>
<p>To get started, we&#8217;ll use the largest available backup plan: auto-month. This
plan will:</p>
<ul class="simple">
<li>Automatically backup your <tt class="docutils literal"><span class="pre">DATABASE_URL</span></tt> database every night.</li>
<li>Retain 7 daily backups.</li>
<li>Retain 5 weekly backups.</li>
<li>Retain 10 manual backups.</li>
</ul>
<p>To get it going, install the addon:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku addons:add pgbackups:auto-month
<span class="go">----&gt; Adding pgbackups:auto-month to deploydjango... done, v14 (free)</span>
<span class="go">      You can now use &quot;pgbackups&quot; to backup your databases or import an external backup.</span>
</pre></div>
</div>
<p>Once you&#8217;ve got the addon installed, Heroku will start automatically backing up
your primary database each day.</p>
<p>To view a list of your available backups, you can run the <tt class="docutils literal"><span class="pre">pgbackups</span></tt>
command. Since we just installed the auto-month backup plan, however, we&#8217;ve got
no existing backups:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pgbackups
<span class="go"> !    No backups. Capture one with `heroku pgbackups:capture`.</span>
</pre></div>
</div>
<p>Let&#8217;s fix that right now by forcing a manual backup:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pgbackups:capture

<span class="go">SHARED_DATABASE (DATABASE_URL)  ----backup---&gt;  b001</span>

<span class="go">Capturing... done</span>
<span class="go">Storing... done</span>
</pre></div>
</div>
<p>Now, if we run the <tt class="docutils literal"><span class="pre">pgbackups</span></tt> command again, we should see:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pgbackups
<span class="go">ID   | Backup Time         | Size       | Database</span>
<span class="go">-----+---------------------+------------+----------------</span>
<span class="go">b001 | 2012/04/20 23:09.50 | 918.0bytes | SHARED_DATABASE</span>
</pre></div>
</div>
<p>As time progresses, and we gradually get more backups, they&#8217;ll show up in the
<tt class="docutils literal"><span class="pre">pgbackups</span></tt> listing.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the backup example above, we backed up our default database
(<tt class="docutils literal"><span class="pre">DATABASE_URL</span></tt>). If you&#8217;d like to backup another database, you can do so
by specifying its name, for example: <tt class="docutils literal"><span class="pre">heroku</span> <span class="pre">pgbackups:capture</span>
<span class="pre">HEROKU_POSTGRESQL_GREEN</span></tt>.</p>
</div>
<p>As a quick note: all manually captured backups display with a <tt class="docutils literal"><span class="pre">b</span></tt> prefix in
the <tt class="docutils literal"><span class="pre">heroku</span> <span class="pre">pgbackups</span></tt> listing, while all automatically captured backups
display with an <tt class="docutils literal"><span class="pre">a</span></tt> prefix.</p>
</div>
<div class="section" id="downloading-your-backups">
<h2>Downloading Your Backups<a class="headerlink" href="#downloading-your-backups" title="Permalink to this headline">¶</a></h2>
<p>So you&#8217;ve got a few database backups, and you&#8217;d like to download them&#8211;no
problem! Assuming you&#8217;ve got the following backup available:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pgbackups
<span class="go">ID   | Backup Time         | Size       | Database</span>
<span class="go">-----+---------------------+------------+----------------</span>
<span class="go">b001 | 2012/04/20 23:09.50 | 918.0bytes | SHARED_DATABASE</span>
</pre></div>
</div>
<p>You can create a publicly available download URL from <a class="reference external" href="http://aws.amazon.com/s3/">Amazon S3</a> (which is good for 10 minutes) by running:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pgbackups:url b001
<span class="go">&quot;https://s3.amazonaws.com/hkpgbackups/app4444444@heroku.com/b001.dump?AWSAccessKeyId=test&amp;Expires=1334989747&amp;Signature=Juy%2FKGQvJ5zPLknUUOFSEAoEGyc%3D&quot;</span>
</pre></div>
</div>
<p>Which you can then download directly to your computer using <tt class="docutils literal"><span class="pre">wget</span></tt>, <tt class="docutils literal"><span class="pre">curl</span></tt>,
or any other standard tool.</p>
</div>
<div class="section" id="restoring-from-a-backup">
<h2>Restoring From a Backup<a class="headerlink" href="#restoring-from-a-backup" title="Permalink to this headline">¶</a></h2>
<p>While backing up your database is always a good idea, your backups will do you
no good unless you know how to restore from the backup when things go wrong.</p>
<p>Assuming you have the following backup available:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pgbackups
<span class="go">ID   | Backup Time         | Size       | Database</span>
<span class="go">-----+---------------------+------------+----------------</span>
<span class="go">b001 | 2012/04/20 23:09.50 | 918.0bytes | SHARED_DATABASE</span>
</pre></div>
</div>
<p>You can restore your backup (<tt class="docutils literal"><span class="pre">b001</span></tt> in this case) to <em>any</em> of your available
databases using the <tt class="docutils literal"><span class="pre">pgbackups:restore</span></tt> command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pgbackups:restore SHARED_DATABASE b001

<span class="go">SHARED_DATABASE (DATABASE_URL)  &lt;---restore---  b001</span>
<span class="go">                                                SHARED_DATABASE</span>
<span class="go">                                                2012/04/20 23:09.50</span>
<span class="go">                                                918.0bytes</span>

<span class="go"> !    WARNING: Potentially Destructive Action</span>
<span class="go"> !    This command will affect the app: deploydjango</span>
<span class="go"> !    To proceed, type &quot;deploydjango&quot; or re-run this command with --confirm deploydjango</span>

<span class="gp">&gt;</span> deploydjango

<span class="go">Retrieving... done</span>
<span class="go">Restoring... done</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The restoration process make take a few minutes if your backups are large.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="resources.html" title="Resources"
             >next</a></li>
        <li class="right" >
          <a href="setup.html" title="Setup"
             >previous</a> |</li>
        <li><a href="../index.html">Deploy Django</a> &raquo;</li>
          <li><a href="index.html" >PostgreSQL</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Randall Degges, Craig Kerstiens.
      Last updated on Apr 21, 2012.
    </div>
  </body>
</html>