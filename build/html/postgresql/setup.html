

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Setup &mdash; Useful Patterns for Deploying Django on Heroku</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Useful Patterns for Deploying Django on Heroku" href="../index.html" />
    <link rel="up" title="PostgreSQL" href="index.html" />
    <link rel="next" title="Advanced" href="advanced.html" />
    <link rel="prev" title="About" href="about.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="advanced.html" title="Advanced"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="about.html" title="About"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Deploy Django</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">PostgreSQL</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Setup</a><ul>
<li><a class="reference internal" href="#bootstraping-a-database">Bootstraping a Database</a></li>
<li><a class="reference internal" href="#configuring-django-to-use-postgresql">Configuring Django to Use PostgreSQL</a></li>
<li><a class="reference internal" href="#destroying-a-database">Destroying a Database</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="about.html"
                        title="previous chapter">About</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="advanced.html"
                        title="next chapter">Advanced</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h1>
<p>Through the rest of this article, I&#8217;ll assume you&#8217;ve already got a working
Heroku application setup, and that you&#8217;re using the <a class="reference external" href="https://toolbelt.heroku.com/">Heroku CLI tool</a>.</p>
<div class="section" id="bootstraping-a-database">
<h2>Bootstraping a Database<a class="headerlink" href="#bootstraping-a-database" title="Permalink to this headline">¶</a></h2>
<p>To get started, let&#8217;s bootstrap a new PostgreSQL server instance. In the
example below, we&#8217;ll create a free (shared) PostgreSQL database:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku addons:add shared-database
<span class="go">----&gt; Adding shared-database to deploydjango... done, v2 (free)</span>
</pre></div>
</div>
<p>If we wanted to create a larger (paid) database, we could run the following command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku addons:add heroku-postgresql:ronin
<span class="go">----&gt; Adding heroku-postgresql:ronin to deploydjango... done, v3 ($200/mo)</span>
<span class="go">      Attached as HEROKU_POSTGRESQL_IVORY</span>
<span class="go">      The database should be available in 3-5 minutes</span>
<span class="go">      Use `heroku pg:wait` to track status</span>
</pre></div>
</div>
<p>To verify that our database(s) exist, we can now run the <tt class="docutils literal"><span class="pre">pg:info</span></tt> command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pg:info
<span class="go">=== SHARED_DATABASE (DATABASE_URL)</span>
<span class="go">Data Size    (empty)</span>
<span class="go">=== HEROKU_POSTGRESQL_GREEN_URL</span>
<span class="go">Plan         Ronin</span>
<span class="go">Status       preparing</span>
<span class="go">Data Size    -1 B</span>
<span class="go">Tables       -1</span>
<span class="go">PG Version   ?</span>
<span class="go">Created      2012-04-20 07:26 UTC</span>
<span class="go">Conn Info    &quot;host=ec2-yy-yy-yy-yy.compute-1.amazonaws.com</span>
<span class="go">             port=5432 dbname=yyyyy</span>
<span class="go">             user=yyyyy sslmode=require</span>
<span class="go">             password=yyyyy&quot;</span>
<span class="go">Maintenance  not required</span>
</pre></div>
</div>
<p>As you can see from the output above, our Heroku application now has two
databases defined, a free (shared) database, and a paid database.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can find a complete list of available Heroku databases plans on their
<a class="reference external" href="https://postgres.heroku.com/pricing">pricing page</a>.</p>
</div>
<p>As you can also see&#8211;there are obviously some differences between the shared
database we created, and the paid database:</p>
<ul class="simple">
<li>The shared database is created insantly (there is no delay), while the paid
database is provisioned on the fly, and takes a minute or so to become available.</li>
<li>The paid database lists connection info while the shared database does not.
This is because paid databases allow you to directly connect to them using
the <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/app-psql.html">psql</a> tool
like you would with any normal PostgreSQL database.</li>
</ul>
</div>
<div class="section" id="configuring-django-to-use-postgresql">
<h2>Configuring Django to Use PostgreSQL<a class="headerlink" href="#configuring-django-to-use-postgresql" title="Permalink to this headline">¶</a></h2>
<p>Now that we&#8217;ve got a database running, let&#8217;s configure our Django site to use
it!</p>
<p>Like all other Heroku addons&#8211;when we created our database in the previous
section, Heroku added a couple environment variables to our application, which
specify our newly created database information. Let&#8217;s quickly take a look:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku config
<span class="go">DATABASE_URL                =&gt; postgres://xxxxx:xxxxx@ec2-xx-xx-xx-xx.compute-1.amazonaws.com/xxxxx</span>
<span class="go">HEROKU_POSTGRESQL_GREEN_URL =&gt; postgres://yyyyy:yyyyy@ec2-yy-yy-yy-yy.compute-1.amazonaws.com:5432/yyyyy</span>
<span class="go">SHARED_DATABASE_URL         =&gt; postgres://xxxxx:xxxxx@ec2-xx-xx-xx-xx.compute-1.amazonaws.com/xxxxx</span>
</pre></div>
</div>
<p>As you can see, we&#8217;ve now got 3 environment variables defined. One for each our
our databases, and one extra variable, <tt class="docutils literal"><span class="pre">DATABASE_URL</span></tt>. The <tt class="docutils literal"><span class="pre">DATABASE_URL</span></tt>
variable is a special variable, in that its only purpose is to provide a
standardized &#8216;default&#8217; database for your application.</p>
<p>At the moment, it looks like our shared database (<tt class="docutils literal"><span class="pre">SHARED_DATABASE_URL</span></tt>) is
set as the default database (<tt class="docutils literal"><span class="pre">DATABASE_URL</span></tt>). If we wanted to set our larger
(and more performant) database (<tt class="docutils literal"><span class="pre">HEROKU_POSTGRESQL_GREEN_URL</span></tt>) as the
default, we could do so by running the <tt class="docutils literal"><span class="pre">pg:promote</span></tt> command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku pg:promote HEROKU_POSTGRESQL_GREEN
<span class="go">-----&gt; Promoting HEROKU_POSTGRESQL_GREEN to DATABASE_URL... done</span>

<span class="gp">$</span> heroku config
<span class="go">DATABASE_URL                =&gt; postgres://yyyyy:yyyyy@ec2-yy-yy-yy-yy.compute-1.amazonaws.com:5432/yyyyy</span>
<span class="go">HEROKU_POSTGRESQL_GREEN_URL =&gt; postgres://yyyyy:yyyyy@ec2-yy-yy-yy-yy.compute-1.amazonaws.com:5432/yyyyy</span>
<span class="go">SHARED_DATABASE_URL         =&gt; postgres://xxxxx:xxxxx@ec2-xx-xx-xx-xx.compute-1.amazonaws.com/xxxxx</span>
</pre></div>
</div>
<p>Now our ronin database is the default!</p>
<p>The next thing we need to do is tell Django to use our new Heroku database.
What we&#8217;re going to do is tell Django to use our <tt class="docutils literal"><span class="pre">DATABASE_URL</span></tt> database just
like we would any other database, with one exception: instead of hard-coding in
our database credentials&#8211;we&#8217;ll simply grab them from the environment!</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># settings.py</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span>

<span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">])</span>
    <span class="n">DATABASES</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s">&#39;django.db.backends.postgresql_psycopg2&#39;</span><span class="p">,</span>
        <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
        <span class="s">&#39;USER&#39;</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
        <span class="s">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
        <span class="s">&#39;HOST&#39;</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
        <span class="s">&#39;PORT&#39;</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Also: don&#8217;t forget to add <tt class="docutils literal"><span class="pre">psycopg2</span></tt> to your <tt class="docutils literal"><span class="pre">requirements.txt</span></tt> file, since
the <tt class="docutils literal"><span class="pre">psycopg2</span></tt> library is required for Django to interface with PostgreSQL:</p>
<div class="highlight-none"><div class="highlight"><pre># requirements.txt
psycopg2==2.4.5
...
</pre></div>
</div>
<p>Now that we&#8217;ve got Django configured to use whichever database is currently set
to <tt class="docutils literal"><span class="pre">DATABASE_URL</span></tt>, we can easily switch our primary database without changing
a single line of code!</p>
</div>
<div class="section" id="destroying-a-database">
<h2>Destroying a Database<a class="headerlink" href="#destroying-a-database" title="Permalink to this headline">¶</a></h2>
<p>If you&#8217;d like to remove a database that you&#8217;ve already provisioned, you can do
so via the <tt class="docutils literal"><span class="pre">addons:remove</span></tt> command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> heroku addons:remove HEROKU_POSTGRESQL_GREEN
<span class="go"> !    WARNING: Potentially Destructive Action</span>
<span class="go"> !    This command will affect the app: deploydjango</span>
<span class="go"> !    To proceed, type &quot;deploydjango&quot; or re-run this command with --confirm deploydjango</span>

<span class="gp">&gt;</span> deploydjango
<span class="go">----&gt; Removing HEROKU_POSTGRESQL_GREEN from deploydjango... done, v9 ($200/mo)</span>
</pre></div>
</div>
<p>Heroku bills for database usage by the second, so as soon as your database has
been removed, you&#8217;ll stop being charged.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="advanced.html" title="Advanced"
             >next</a></li>
        <li class="right" >
          <a href="about.html" title="About"
             >previous</a> |</li>
        <li><a href="../index.html">Deploy Django</a> &raquo;</li>
          <li><a href="index.html" >PostgreSQL</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Randall Degges, Craig Kerstiens.
      Last updated on Apr 21, 2012.
    </div>
  </body>
</html>